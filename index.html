<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Read and Write Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
        }
        #sendButton {
            margin-top: 10px;
        }
        #readButton {
            margin-top: 10px;
        }
        #inputField {
            margin-top: 10px;
        }
        #receivedData {
            margin-top: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #connectButton, #disconnectButton {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>1 BLE Read and Write Example</h1>
    <button id="scanBtn">Scan for BLE Devices</button>
    <div id="status">Status: Not connected</div>

    <div id="inputField" style="display:none;">
        <label for="dataToSend">Enter Data to Send:</label>
        <input type="text" id="dataToSend" placeholder="Enter text to send" />
        <button id="sendButton">Send Data</button>
        <button id="connectButton">Connect</button>
        <button id="disconnectButton">Disconnect</button>
    </div>

    <div id="receivedData" style="display:none;">
        <p><strong>Received Data:</strong> <span id="dataDisplay">None</span></p>
    </div>

    <script>
        const scanButton = document.getElementById("scanBtn");
        const statusDiv = document.getElementById("status");
        const sendButton = document.getElementById("sendButton");
        const connectButton = document.getElementById("connectButton");
        const disconnectButton = document.getElementById("disconnectButton");
        const inputField = document.getElementById("inputField");
        const receivedDataDiv = document.getElementById("receivedData");
        const dataDisplay = document.getElementById("dataDisplay");
        const dataToSendInput = document.getElementById("dataToSend");

        let currentDevice;
        let currentServer;
        let readCharacteristic;
        let writeCharacteristic;

        // UUIDs for the service and characteristics
        const SERVICE_UUID = 'f000c0c0-0451-4000-b000-000000000000';
        const READ_CHARACTERISTIC_UUID = 'f000c0c2-0451-4000-b000-000000000000';
        const WRITE_CHARACTERISTIC_UUID = 'f000c0c1-0451-4000-b000-000000000000';

        // Function to start scanning for BLE devices
        async function scanAndConnect() {
            try {
                // Request the BLE device with the specific service UUID
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, // Accept any BLE device
                    optionalServices: [SERVICE_UUID]  // Request the service UUID
                });

                currentDevice = device;

                // Update status
                statusDiv.textContent = `Found device: ${device.name || 'Unnamed device'}`;

                // Establish a connection to the GATT server
                currentServer = await device.gatt.connect();

                // Discover the service and get the read and write characteristics
                const service = await currentServer.getPrimaryService(SERVICE_UUID);
                readCharacteristic = await service.getCharacteristic(READ_CHARACTERISTIC_UUID);
                writeCharacteristic = await service.getCharacteristic(WRITE_CHARACTERISTIC_UUID);

                // Update status
                statusDiv.textContent = `Connected to ${device.name || 'Unnamed device'}`;

                // Show the input field and buttons
                inputField.style.display = 'block';
                receivedDataDiv.style.display = 'block';

                // Listen for changes in the read characteristic (data received)
                if (readCharacteristic.startNotifications) {
                    await readCharacteristic.startNotifications();
                    readCharacteristic.addEventListener('characteristicvaluechanged', handleReceivedData);
                }

            } catch (error) {
                console.error("Error during connection", error);
                statusDiv.textContent = `Connection failed: ${error.message || error}`;
            }
        }

        // Function to handle received data from the read characteristic
        function handleReceivedData(event) {
            const value = event.target.value;
            const decoder = new TextDecoder();
            const text = decoder.decode(value);

            console.log('Received data:', text);
            dataDisplay.textContent = text; // Update the screen with the received data
        }

        // Function to send data to the write characteristic
        async function sendData() {
            try {
                const dataToSend = dataToSendInput.value.trim(); // Get the text entered by the user
                if (dataToSend === "") {
                    alert("Please enter some text to send!");
                    return;
                }

                const encoder = new TextEncoder();
                const data = encoder.encode(dataToSend);

                // Write data to the write characteristic
                await writeCharacteristic.writeValue(data);

                console.log('Data sent:', dataToSend);
                statusDiv.textContent = `Sent data: ${dataToSend}`;

                // Clear the input field after sending the data
                dataToSendInput.value = "";

            } catch (error) {
                console.error("Failed to send data", error);
                statusDiv.textContent = `Failed to send data: ${error.message || error}`;
            }
        }

        // Function to send the connect command (hex values)
        async function sendConnectCommand() {
            const connectData = new Uint8Array([0x24, 0x45, 0x45, 0x50, 0x6D, 0x72, 0x65, 0x6C, 0x61, 0x79, 0x6F, 0x6E, 0x23, 0x0D, 0x0D]);
            await writeCharacteristic.writeValue(connectData);
            statusDiv.textContent = "Sent connect command";
        }

        // Function to send the disconnect command (hex values)
        async function sendDisconnectCommand() {
            const disconnectData = new Uint8Array([0x24, 0x45, 0x45, 0x50, 0x6D, 0x72, 0x65, 0x6C, 0x61, 0x79, 0x6F, 0x66, 0x66, 0x23, 0x0D]);
            await writeCharacteristic.writeValue(disconnectData);
            statusDiv.textContent = "Sent disconnect command";
        }

        // Attach event listener to scan button
        scanButton.addEventListener("click", () => {
            statusDiv.textContent = "Scanning for devices...";
            scanAndConnect();
        });

        // Attach event listener to send data button
        sendButton.addEventListener("click", sendData);

        // Attach event listener to connect button
        connectButton.addEventListener("click", sendConnectCommand);

        // Attach event listener to disconnect button
        disconnectButton.addEventListener("click", sendDisconnectCommand);
    </script>
</body>
</html>
