<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Read and Write Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
        }
        #sendButton {
            margin-top: 10px;
        }
        #readButton {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>1 BLE Read and Write Example</h1>
    <button id="scanBtn">Scan for BLE Devices</button>
    <div id="status">Status: Not connected</div>

    <button id="sendButton" style="display:none;">Send Data</button>
    <button id="readButton" style="display:none;">Read Data</button>

    <script>
        const scanButton = document.getElementById("scanBtn");
        const statusDiv = document.getElementById("status");
        const sendButton = document.getElementById("sendButton");
        const readButton = document.getElementById("readButton");

        let currentDevice;
        let currentServer;
        let readCharacteristic;
        let writeCharacteristic;

        // UUID for the service and characteristics
        const SERVICE_UUID = 'f000c0c0-0451-4000-6000-000000000000';
        const READ_CHARACTERISTIC_UUID = 'f000c0c1-0451-4000-6000-000000000000';
        const WRITE_CHARACTERISTIC_UUID = 'f000c0c2-0451-4000-6000-000000000000';

        // Function to start scanning for BLE devices
        async function scanAndConnect() {
            try {
                // Request the BLE device with the specific service UUID
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, // Accept any BLE device
                    optionalServices: [SERVICE_UUID]  // Request the service UUID
                });

                currentDevice = device;

                // Update status
                statusDiv.textContent = `Found device: ${device.name || 'Unnamed device'}`;

                // Establish a connection to the GATT server
                currentServer = await device.gatt.connect();

                // Discover the service and get the read and write characteristics
                const service = await currentServer.getPrimaryService(SERVICE_UUID);
                readCharacteristic = await service.getCharacteristic(READ_CHARACTERISTIC_UUID);
                writeCharacteristic = await service.getCharacteristic(WRITE_CHARACTERISTIC_UUID);

                // Update status
                statusDiv.textContent = `Connected to ${device.name || 'Unnamed device'}`;

                // Show the buttons to interact with the device
                sendButton.style.display = 'inline-block';
                readButton.style.display = 'inline-block';

            } catch (error) {
                console.error("Error during connection", error);
                statusDiv.textContent = `Connection failed: ${error.message || error}`;
            }
        }

        // Function to read data from the read characteristic
        async function readData() {
            try {
                // Read the value of the read characteristic
                const value = await readCharacteristic.readValue();
                const decoder = new TextDecoder();
                const text = decoder.decode(value);

                console.log('Received data:', text);
                statusDiv.textContent = `Read data: ${text}`;
            } catch (error) {
                console.error("Failed to read data", error);
                statusDiv.textContent = `Failed to read data: ${error.message || error}`;
            }
        }

        // Function to send data to the write characteristic
        async function sendData() {
            try {
                const dataToSend = "Hello from Web Bluetooth!"; // Example data to send
                const encoder = new TextEncoder();
                const data = encoder.encode(dataToSend);

                // Write data to the write characteristic
                await writeCharacteristic.writeValue(data);

                console.log('Data sent:', dataToSend);
                statusDiv.textContent = `Sent data: ${dataToSend}`;
            } catch (error) {
                console.error("Failed to send data", error);
                statusDiv.textContent = `Failed to send data: ${error.message || error}`;
            }
        }

        // Attach event listener to scan button
        scanButton.addEventListener("click", () => {
            statusDiv.textContent = "Scanning for devices...";
            scanAndConnect();
        });

        // Attach event listener to read data button
        readButton.addEventListener("click", readData);

        // Attach event listener to send data button
        sendButton.addEventListener("click", sendData);
    </script>
</body>
</html>
