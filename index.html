<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Scan and Connect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
        }
        #sendButton {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>BLE Scan and Connect</h1>
    <button id="scanBtn">Scan for BLE Devices</button>
    <div id="status">Status: Not connected</div>

    <button id="sendButton" style="display:none;">Send Data</button>

    <script>
        const scanButton = document.getElementById("scanBtn");
        const statusDiv = document.getElementById("status");
        const sendButton = document.getElementById("sendButton");

        let currentDevice;
        let currentServer;
        let rxCharacteristic;
        let txCharacteristic;

        // Replace with your actual RX and TX UUIDs
        const RX_UUID = 'f000c0c1-0451-4000-6000-000000000000';  // Example: '00002a19-0000-1000-8000-00805f9b34fb'
        const TX_UUID = 'f000c0c2-0451-4000-6000-000000000000';  // Example: '00002a19-0000-1000-8000-00805f9b34fb'
        const SERVICE_UUID = 'f000c0c0-0451-4000-6000-000000000000';  // Replace with the service UUID of your BLE device

        // Function to start scanning for all BLE devices
        async function scanAndConnect() {
            try {
                // Request any BLE device (no specific service filter)
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, // Accept any BLE device
                    optionalServices: [SERVICE_UUID]  // Only request services that the device exposes
                });

                currentDevice = device;

                // Update status
                statusDiv.textContent = `Found device: ${device.name || 'Unnamed device'}`;

                // Establish a connection to the GATT server
                currentServer = await device.gatt.connect();

                // Once connected, discover services and characteristics
                const service = await currentServer.getPrimaryService(SERVICE_UUID);

                // Get the TX (write) and RX (read) characteristics
                txCharacteristic = await service.getCharacteristic(TX_UUID);
                rxCharacteristic = await service.getCharacteristic(RX_UUID);

                // Listen for changes on the RX characteristic (if it supports notifications)
                if (rxCharacteristic.startNotifications) {
                    await rxCharacteristic.startNotifications();
                    rxCharacteristic.addEventListener('characteristicvaluechanged', handleReceivedData);
                }

                // Update status
                statusDiv.textContent = `Connected to ${device.name || 'Unnamed device'}`;
                sendButton.style.display = 'inline-block'; // Show the Send button after connection

            } catch (error) {
                console.error("Error in connection process:", error);
                statusDiv.textContent = `Connection failed: ${error.message || error}`;
            }
        }

        // Function to handle received data from RX characteristic
        function handleReceivedData(event) {
            const value = event.target.value;
            const decoder = new TextDecoder();
            const text = decoder.decode(value);
            console.log('Received data:', text);
            statusDiv.textContent = `Received: ${text}`;
        }

        // Function to send data via the TX characteristic
        async function sendData() {
            try {
                const dataToSend = "24 45 45 50 6D 65 72 23 0D"; // Data to send
                const encoder = new TextEncoder();
                const data = encoder.encode(dataToSend);

                // Write to TX characteristic
                await txCharacteristic.writeValue(data);

                console.log('Data sent:', dataToSend);
                statusDiv.textContent = `Sent data: ${dataToSend}`;
            } catch (error) {
                console.error("Failed to send data", error);
                statusDiv.textContent = `Failed to send data: ${error.message || error}`;
            }
        }

        // Attach event listener to scan button
        scanButton.addEventListener("click", () => {
            statusDiv.textContent = "Scanning for devices...";
            scanAndConnect();
        });

        // Attach event listener to send data button
        sendButton.addEventListener("click", sendData);
    </script>
</body>
</html>
